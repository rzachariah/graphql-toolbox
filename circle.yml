machine:
  java:
    version: openjdk8
  node:
    version: 6.8.0
  services:
    - docker

  # Double heap memory for potentially faster compile times
  environment:
    SBT_OPTS: "-XX:+CMSClassUnloadingEnabled -Xms3072m -Xmx3072m -XX:MaxPermSize=768m -XX:ReservedCodeCacheSize=384m -Dfile.encoding=UTF8"

dependencies:
  override:
    - docker info
    # Install npm dependencies
    - npm install
    # Build container
    - sbt docker:publishLocal
    # Previous step built a container named graphql-toolbox:1.0-SNAPSHOT. Tag with better names
    - docker tag graphql-toolbox:1.0-SNAPSHOT $IMAGE_NAME
    - docker tag graphql-toolbox:1.0-SNAPSHOT $IMAGE_NAME:$VERSION

test:
  override:
    # Run container
    - docker run --name graphql-toolbox -d -p 9000:9000 $IMAGE_NAME:$VERSION; sleep 10
    - docker ps -a
    - docker logs graphql-toolbox
    # Hit URL
    - curl --retry 10 --retry-delay 5 -v http://localhost:9000

deployment:
  hub:
    branch: master
    commands:
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
      - docker push $IMAGE_NAME